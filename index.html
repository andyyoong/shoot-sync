<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShootSync | Pro Bulk</title>
    <style>
        :root { 
            --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; --muted: #64748b;
            --blue: #3b82f6; --green: #10b981; --red: #ef4444; --gold: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-btn { background: var(--bg); color: var(--text); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }

        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--muted); margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { aspect-ratio: 1/1; background: var(--bg); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 8px; font-size: 14px; position: relative; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        
        /* Selection Styles */
        .day.selected { border-color: var(--blue); background: rgba(59, 130, 246, 0.25); transform: scale(0.95); }
        .day.perfect { border-color: var(--gold); background: rgba(245, 158, 11, 0.1); }
        .day.perfect::after { content: '‚òÖ'; color: var(--gold); position: absolute; font-size: 10px; top: 2px; right: 4px; }
        
        .crew-dots { display: flex; gap: 3px; margin-top: auto; margin-bottom: 8px; flex-wrap: wrap; justify-content: center; width: 80%; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #334155; }
        .dot.active { background: var(--green); }

        .action-panel { display: flex; flex-direction: column; gap: 12px; }
        select { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--muted); background: var(--bg); color: var(--text); font-size: 16px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-clear { background: transparent; color: var(--muted); font-size: 12px; text-decoration: underline; margin-top: 5px; cursor: pointer; border: none; }
        
        .status-msg { font-size: 14px; color: var(--gold); text-align: center; min-height: 20px; font-weight: 500; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)">‚ùÆ</button>
        <h2 id="month-display">Loading...</h2>
        <button class="nav-btn" onclick="changeMonth(1)">‚ùØ</button>
    </div>
    <div class="weekdays">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="grid" id="calendar-grid"></div>
</div>

<div class="card action-panel">
    <select id="user-select">
        <option value="Andy">üë§ Andy</option>
        <option value="Matt">üë§ Matt</option>
        <option value="Veronica">üë§ Veronica</option>
        <option value="Mike">üë§ Mike</option>
    </select>
    
    <div class="status-msg" id="status-label">Select dates on the calendar</div>
    
    <div class="btn-group">
        <button class="btn btn-green" id="btn-avail" onclick="submitBulk('Available')">Mark Selected Free</button>
        <button class="btn btn-red" id="btn-busy" onclick="submitBulk('Busy')">Mark Selected Busy</button>
    </div>
    <button class="btn-clear" onclick="clearSelection()">Clear Selection</button>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyFLidUKIB-efwm-CWNzed_00EsxK77U4Aks3sL_tXXdvBlmTz7TC0bxm-66YcpFI8QWA/exec'; 
    const crew = ['Andy', 'Matt', 'Veronica', 'Mike'];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDates = new Set(); 
    let globalData = [];

    function renderCalendar() {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month-display').innerText = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const isSelected = selectedDates.has(dateStr) ? 'selected' : '';
            grid.innerHTML += `
                <div class="day ${isSelected}" id="day-${dateStr}" onclick="toggleDate('${dateStr}')">
                    ${d}
                    <div class="crew-dots">
                        ${crew.map(name => `<div class="dot" id="dot-${name}-${dateStr}"></div>`).join('')}
                    </div>
                </div>`;
        }
        applyDataToGrid();
    }

    function toggleDate(dateStr) {
        if (selectedDates.has(dateStr)) {
            selectedDates.delete(dateStr);
        } else {
            selectedDates.add(dateStr);
        }
        updateUI();
    }

    function updateUI() {
        // Update calendar visuals
        document.querySelectorAll('.day').forEach(el => {
            const dStr = el.id.replace('day-', '');
            selectedDates.has(dStr) ? el.classList.add('selected') : el.classList.remove('selected');
        });
        
        // Update label
        const count = selectedDates.size;
        document.getElementById('status-label').innerText = count > 0 ? `${count} dates selected` : "Select dates on the calendar";
    }

    function clearSelection() {
        selectedDates.clear();
        updateUI();
    }

    function changeMonth(dir) {
        currentMonth += dir;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar();
    }

    async function fetchData() {
        try {
            const response = await fetch(scriptURL);
            globalData = await response.json();
            applyDataToGrid();
        } catch (e) { console.log("Syncing..."); }
    }

    function applyDataToGrid() {
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.day').forEach(d => d.classList.remove('perfect'));

        const latestStatus = {};
        globalData.forEach(entry => {
            const cleanDate = entry.date.split('T')[0];
            latestStatus[`${entry.name}-${cleanDate}`] = entry.status;
        });

        for (const [key, status] of Object.entries(latestStatus)) {
            const [name, date] = key.split('-');
            const dot = document.getElementById(`dot-${name}-${date}`);
            if (dot && status === 'Available') dot.classList.add('active');
        }

        document.querySelectorAll('.day').forEach(dayBox => {
            const activeDots = dayBox.querySelectorAll('.dot.active').length;
            if (activeDots >= crew.length) dayBox.classList.add('perfect');
        });
    }

    async function submitBulk(status) {
        if (selectedDates.size === 0) return alert("Tap some dates first!");
        
        const user = document.getElementById('user-select').value;
        const btn = status === 'Available' ? document.getElementById('btn-avail') : document.getElementById('btn-busy');
        const originalText = btn.innerText;
        
        btn.innerText = "Syncing...";
        btn.disabled = true;

        // Process all selected dates
        const dateArray = Array.from(selectedDates);
        
        try {
            // We use Promise.all to send all dates to Google Sheets at once
            await Promise.all(dateArray.map(dStr => 
                fetch(scriptURL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ name: user, date: dStr, status: status }) 
                })
            ));
            
            selectedDates.clear();
            updateUI();
            setTimeout(fetchData, 1000);
            alert(`Updated ${dateArray.length} dates for ${user}`);
        } catch (e) {
            alert("Error syncing. Check connection.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    renderCalendar();
    fetchData();
    setInterval(fetchData, 10000);
</script>
</body>
</html>
