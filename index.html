<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShootSync | Production Portal</title>
    <style>
        :root { --blue: #007aff; --green: #34c759; --red: #ff3b30; --gold: #ffcc00; --dark: #1c1c1e; --gray: #8e8e93; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f7; margin: 0; padding: 15px; color: var(--dark); }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h2 { font-size: 1.2rem; margin: 0 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
        
        /* Calendar Grid */
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day { aspect-ratio: 1/1; background: #fff; border: 1px solid #e5e5ea; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; position: relative; transition: 0.2s; }
        .perfect { background: var(--gold) !important; border-color: #f59e0b; font-weight: bold; }
        
        .crew-dots { display: flex; gap: 2px; margin-top: 4px; flex-wrap: wrap; justify-content: center; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #ddd; border: 1px solid rgba(0,0,0,0.05); }
        .dot.active { background: var(--green); }

        /* Controls */
        select, input, .btn { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { background: var(--blue); color: white; font-weight: 600; border: none; cursor: pointer; margin-bottom: 5px; }
        .btn-red { background: white; color: var(--red); border: 1px solid var(--red); margin-top: 5px; }
        .btn:disabled { opacity: 0.5; }

        .legend { display: flex; gap: 10px; font-size: 10px; color: var(--gray); margin-top: 10px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="month-display">February 2026</h2>
    <div class="grid" id="calendar-grid"></div>
    <div class="legend">
        <div class="legend-item"><div class="dot active"></div> Free</div>
        <div class="legend-item"><div class="dot"></div> Busy</div>
        <div class="legend-item"><span style="color:orange">â˜…</span> Shoot Ready</div>
    </div>
</div>

<div class="card">
    <h2>My Status</h2>
    <select id="user-select">
        <option value="Andy">Andy</option>
        <option value="Matt">Matt</option>
        <option value="Veronica">Veronica</option>
        <option value="Mike">Mike</option>
    </select>
    <input type="date" id="date-input">
    <button class="btn" id="submit-btn" onclick="updateStatus('Available')">I'm Available</button>
    <button class="btn btn-red" id="remove-btn" onclick="updateStatus('Busy')">Mark as Busy/Remove</button>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw5tXqEAHCa66p_5n93ay61DKVzn320GTwt1AI5pjaqWu7UQJGBfb8Y3XtJaSWeeh0l/exec';
    const crew = ['Andy', 'Matt', 'Veronica', 'Mike'];

    function initCalendar() {
        const now = new Date();
        const month = now.getMonth();
        const year = now.getFullYear();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month-display').innerText = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=daysInMonth; d++) {
            // Create a standardized ID like 2026-02-01
            const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            grid.innerHTML += `
                <div class="day" id="date-${dateStr}">
                    ${d}
                    <div class="crew-dots">
                        ${crew.map(name => `<div class="dot" id="dot-${name}-${dateStr}" title="${name}"></div>`).join('')}
                    </div>
                </div>`;
        }
        fetchData();
    }

    async function fetchData() {
        try {
            const response = await fetch(scriptURL);
            const data = await response.json();
            
            // Clear all dots first
            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.day').forEach(d => d.classList.remove('perfect'));

            data.forEach(entry => {
                // Ensure date format matches yyyy-mm-dd
                const cleanDate = entry.date.split('T')[0]; 
                const dotId = `dot-${entry.name}-${cleanDate}`;
                const dot = document.getElementById(dotId);
                
                if (dot) {
                    if (entry.status === 'Available') {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                }

                // Check for "Perfect" day (all 4 crew available)
                const dayBox = document.getElementById(`date-${cleanDate}`);
                if (dayBox) {
                    const activeCount = dayBox.querySelectorAll('.dot.active').length;
                    if (activeCount >= crew.length) {
                        dayBox.classList.add('perfect');
                    }
                }
            });
        } catch (e) {
            console.log("Syncing...");
        }
    }

    async function updateStatus(status) {
        const btn = document.getElementById('submit-btn');
        const user = document.getElementById('user-select').value;
        const date = document.getElementById('date-input').value;

        if (!date) return alert("Please select a date first!");

        btn.innerText = "Syncing...";
        btn.disabled = true;

        const payload = { name: user, date: date, status: status };

        try {
            await fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify(payload) 
            });
            setTimeout(fetchData, 1500); // Refresh UI after a short delay
            alert(`${user} marked as ${status} for ${date}`);
        } catch (e) {
            alert("Error updating status.");
        } finally {
            btn.innerText = "I'm Available";
            btn.disabled = false;
        }
    }

    initCalendar();
    setInterval(fetchData, 8000); // Auto-refresh every 8 seconds
</script>

</body>
</html>
