<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShootSync | Pro Clarity</title>
    <style>
        :root { 
            --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; --muted: #94a3b8;
            --blue: #3b82f6; --green: #10b981; --red: #ef4444; --gold: #f59e0b;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 80px; }
        .card { background: var(--surface); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-btn { background: rgba(255,255,255,0.05); color: var(--text); border: none; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        h2 { margin: 0; font-size: 1.2rem; }

        /* Calendar Styling */
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day { aspect-ratio: 1/1; background: var(--bg); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; position: relative; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .day.selected { border-color: var(--blue); background: rgba(59, 130, 246, 0.15); transform: translateY(-2px); }
        .day.perfect { border-color: var(--gold); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        .day.perfect::after { content: 'üé¨'; position: absolute; top: -8px; right: -4px; font-size: 12px; }
        
        /* The Dots (The "At-a-glance" view) */
        .dot-row { display: flex; gap: 3px; margin-top: 4px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; background: #334155; }
        .dot.free { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .dot.busy { background: var(--red); }

        /* NEW: Crew Detail Section (The "Who is what" view) */
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .date-title { font-weight: bold; color: var(--gold); font-size: 1.1rem; }
        
        .roster-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .crew-row { display: flex; align-items: center; background: rgba(15, 23, 42, 0.5); padding: 12px 15px; border-radius: 12px; border-left: 4px solid #334155; }
        .crew-row.is-free { border-left-color: var(--green); background: rgba(16, 185, 129, 0.05); }
        .crew-row.is-busy { border-left-color: var(--red); background: rgba(239, 68, 68, 0.05); }
        
        .name-box { flex-grow: 1; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .status-pill { font-size: 10px; padding: 4px 8px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
        .pill-free { background: var(--green); color: white; }
        .pill-busy { background: var(--red); color: white; }
        .pill-none { background: #334155; color: var(--muted); }

        /* Action Buttons */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn { padding: 18px; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 2px solid var(--red); }
        select { width: 100%; padding: 18px; border-radius: 14px; border: 1px solid var(--muted); background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)">‚ùÆ</button>
        <h2 id="month-display">...</h2>
        <button class="nav-btn" onclick="changeMonth(1)">‚ùØ</button>
    </div>
    <div class="grid" id="calendar-grid"></div>
</div>

<div class="card" id="detail-section">
    <div class="detail-header">
        <div class="date-title" id="selected-date-text">Tap a date</div>
        <div id="perfect-badge"></div>
    </div>
    <div class="roster-grid" id="crew-roster">
        </div>
</div>

<div class="card">
    <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px; text-align: center;">UPDATING AS:</div>
    <select id="user-select">
        <option value="Andy">üë§ Andy</option>
        <option value="Matt">üë§ Matt</option>
        <option value="Veronica">üë§ Veronica</option>
        <option value="Mike">üë§ Mike</option>
    </select>
    <div class="btn-group">
        <button class="btn btn-green" onclick="submitBulk('Available')">I'M FREE</button>
        <button class="btn btn-red" onclick="submitBulk('Busy')">I'M BUSY</button>
    </div>
    <button style="width: 100%; background: none; border: none; color: var(--muted); margin-top: 15px; text-decoration: underline; cursor:pointer;" onclick="clearSelection()">Clear Selection</button>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxGwBiSjz8GsqG6Qq9xzDMGDGsGBB9BIjIi-yH3IhhVkvoC8oBJlgQpWtf-2bxIYg-Mvw/exec'; // <--- PASTE YOUR /exec URL HERE
    const crew = ['Andy', 'Matt', 'Veronica', 'Mike'];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDates = new Set(); 
    let globalData = [];
    let latestStatuses = {};

    function renderCalendar() {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month-display').innerText = `${monthNames[currentMonth]} ${currentYear}`;
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            grid.innerHTML += `
                <div class="day" id="day-${dateStr}" onclick="toggleDate('${dateStr}')">
                    ${d}
                    <div class="dot-row">
                        ${crew.map(name => `<div class="dot" id="dot-${name}-${dateStr}"></div>`).join('')}
                    </div>
                </div>`;
        }
        applyDataToGrid();
    }

    function toggleDate(dateStr) {
        if (selectedDates.has(dateStr)) selectedDates.delete(dateStr);
        else selectedDates.add(dateStr);
        
        updateDetails(dateStr);
        
        document.querySelectorAll('.day').forEach(el => {
            const d = el.id.replace('day-', '');
            selectedDates.has(d) ? el.classList.add('selected') : el.classList.remove('selected');
        });
    }

    function updateDetails(dateStr) {
        document.getElementById('selected-date-text').innerText = dateStr;
        const roster = document.getElementById('crew-roster');
        
        let freeCount = 0;

        roster.innerHTML = crew.map(name => {
            const status = latestStatuses[`${name}-${dateStr}`] || 'None';
            const isFree = status === 'Available';
            const isBusy = status === 'Busy';
            if(isFree) freeCount++;

            return `
                <div class="crew-row ${isFree ? 'is-free' : (isBusy ? 'is-busy' : '')}">
                    <div class="name-box">
                        ${isFree ? '‚úÖ' : (isBusy ? '‚ùå' : 'üîò')} 
                        ${name}
                    </div>
                    <div class="status-pill ${isFree ? 'pill-free' : (isBusy ? 'pill-busy' : 'pill-none')}">
                        ${status === 'Available' ? 'Free' : (status === 'Busy' ? 'Busy' : 'No Reply')}
                    </div>
                </div>`;
        }).join('');

        const badge = document.getElementById('perfect-badge');
        badge.innerHTML = (freeCount === 4) ? '<span style="color:var(--gold); font-weight:bold;">üåü READY TO SHOOT</span>' : '';
    }

    async function fetchData() {
        try {
            const response = await fetch(scriptURL);
            globalData = await response.json();
            applyDataToGrid();
        } catch (e) { console.log("Syncing..."); }
    }

    function applyDataToGrid() {
        document.querySelectorAll('.dot').forEach(d => { d.className = 'dot'; });
        latestStatuses = {};
        globalData.forEach(entry => {
            const cleanDate = entry.date.split('T')[0];
            latestStatuses[`${entry.name}-${cleanDate}`] = entry.status;
        });

        for (const [key, status] of Object.entries(latestStatuses)) {
            const [name, date] = key.split('-');
            const dot = document.getElementById(`dot-${name}-${date}`);
            if (dot) {
                if (status === 'Available') dot.classList.add('free');
                else if (status === 'Busy') dot.classList.add('busy');
            }
        }

        document.querySelectorAll('.day').forEach(dayBox => {
            const dateStr = dayBox.id.replace('day-', '');
            const allFree = crew.every(name => latestStatuses[`${name}-${dateStr}`] === 'Available');
            if (allFree) dayBox.classList.add('perfect');
            else dayBox.classList.remove('perfect');
        });
    }

    function clearSelection() {
        selectedDates.clear();
        document.querySelectorAll('.day').forEach(el => el.classList.remove('selected'));
    }

    function changeMonth(dir) {
        currentMonth += dir;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar();
    }

    async function submitBulk(status) {
        if (selectedDates.size === 0) return alert("Tap some dates first!");
        const user = document.getElementById('user-select').value;
        const datesToProcess = Array.from(selectedDates);

        // UI Optimistic Update
        datesToProcess.forEach(dStr => {
            latestStatuses[`${user}-${dStr}`] = status;
            const dot = document.getElementById(`dot-${user}-${dStr}`);
            if(dot) dot.className = 'dot ' + (status === 'Available' ? 'free' : 'busy');
            updateDetails(dStr);
        });

        clearSelection();
        try {
            await Promise.all(datesToProcess.map(dStr => 
                fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: user, date: dStr, status: status }) })
            ));
            fetchData();
        } catch (e) { alert("Network error."); }
    }

    renderCalendar();
    fetchData();
    setInterval(fetchData, 20000);
</script>
</body>
</html>
