<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShootSync | Pro Transparency</title>
    <style>
        :root { 
            --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; --muted: #64748b;
            --blue: #3b82f6; --green: #10b981; --red: #ef4444; --gold: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 50px; }
        .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-btn { background: var(--bg); color: var(--text); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }

        /* Calendar Grid */
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day { aspect-ratio: 1/1; background: var(--bg); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 6px; font-size: 13px; position: relative; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .day.selected { border-color: var(--blue); background: rgba(59, 130, 246, 0.2); }
        .day.perfect { border-color: var(--gold); }
        .day.perfect::after { content: '‚òÖ'; color: var(--gold); position: absolute; font-size: 10px; top: 2px; right: 4px; }
        
        /* Crew Dots */
        .crew-dots { display: flex; gap: 2px; margin-top: auto; margin-bottom: 6px; flex-wrap: wrap; justify-content: center; width: 90%; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #334155; border: 1px solid rgba(255,255,255,0.05); }
        .dot.free { background: var(--green); box-shadow: 0 0 4px var(--green); }
        .dot.busy { background: var(--red); }

        /* NEW: Legend Styles */
        .legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #334155; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .l-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Summary & Action Panels */
        .summary-title { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        .crew-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .crew-item { display: flex; align-items: center; gap: 8px; font-size: 14px; background: var(--bg); padding: 8px; border-radius: 8px; }
        .status-badge { width: 8px; height: 8px; border-radius: 50%; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
        
        select { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--muted); background: var(--bg); color: var(--text); margin-bottom: 10px; font-size: 16px; appearance: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)">‚ùÆ</button>
        <h2 id="month-display">...</h2>
        <button class="nav-btn" onclick="changeMonth(1)">‚ùØ</button>
    </div>
    
    <div class="grid" id="calendar-grid"></div>

    <div class="legend">
        <div class="legend-item"><div class="l-dot" style="background:var(--green)"></div> Free</div>
        <div class="legend-item"><div class="l-dot" style="background:var(--red)"></div> Busy</div>
        <div class="legend-item"><div class="l-dot" style="background:#334155"></div> No Reply</div>
        <div class="legend-item"><span style="color:var(--gold)">‚òÖ</span> Shoot Ready</div>
        <div class="legend-item"><div style="width:10px; height:10px; border:1px solid var(--blue); border-radius:2px"></div> Selected</div>
    </div>
</div>

<div class="card" id="detail-card">
    <span class="summary-title" id="detail-date-label">Tap a date to see crew status</span>
    <div class="crew-list" id="detail-roster"></div>
</div>

<div class="card">
    <select id="user-select">
        <option value="Andy">üë§ Andy</option>
        <option value="Matt">üë§ Matt</option>
        <option value="Veronica">üë§ Veronica</option>
        <option value="Mike">üë§ Mike</option>
    </select>
    <div class="btn-group">
        <button class="btn btn-green" onclick="submitBulk('Available')">Confirm Free</button>
        <button class="btn btn-red" onclick="submitBulk('Busy')">Mark Busy</button>
    </div>
    <center><button style="background:none; border:none; color:var(--muted); margin-top:15px; text-decoration:underline; cursor:pointer;" onclick="clearSelection()">Deselect All</button></center>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzwf0C9Qz_DSc04bWZFswsoupu1qxRf8VSTdsez0B3C1R3FbpBPX1YO5Hux5SCI-833jA/exec'; 
    const crew = ['Andy', 'Matt', 'Veronica', 'Mike'];
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDates = new Set(); 
    let globalData = [];
    let latestStatuses = {};

    function renderCalendar() {
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month-display').innerText = `${monthNames[currentMonth]} ${currentYear}`;
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            grid.innerHTML += `
                <div class="day" id="day-${dateStr}" onclick="toggleDate('${dateStr}')">
                    ${d}
                    <div class="crew-dots">
                        ${crew.map(name => `<div class="dot" id="dot-${name}-${dateStr}"></div>`).join('')}
                    </div>
                </div>`;
        }
        applyDataToGrid();
    }

    function toggleDate(dateStr) {
        if (selectedDates.has(dateStr)) selectedDates.delete(dateStr);
        else selectedDates.add(dateStr);
        
        showDayDetail(dateStr);
        
        document.querySelectorAll('.day').forEach(el => {
            const d = el.id.replace('day-', '');
            selectedDates.has(d) ? el.classList.add('selected') : el.classList.remove('selected');
        });
    }

    function showDayDetail(dateStr) {
        document.getElementById('detail-date-label').innerText = `Crew Status: ${dateStr}`;
        const roster = document.getElementById('detail-roster');
        roster.innerHTML = crew.map(name => {
            const status = latestStatuses[`${name}-${dateStr}`] || 'No Reply';
            const color = status === 'Available' ? 'var(--green)' : (status === 'Busy' ? 'var(--red)' : '#334155');
            return `
                <div class="crew-item">
                    <div class="status-badge" style="background:${color}"></div>
                    <span>${name}</span>
                    <span style="font-size:10px; color:var(--muted); margin-left:auto">${status}</span>
                </div>`;
        }).join('');
    }

    async function fetchData() {
        try {
            const response = await fetch(scriptURL);
            globalData = await response.json();
            applyDataToGrid();
        } catch (e) { console.log("Background Syncing..."); }
    }

    function applyDataToGrid() {
        document.querySelectorAll('.dot').forEach(d => { d.className = 'dot'; });
        
        latestStatuses = {};
        globalData.forEach(entry => {
            const cleanDate = entry.date.split('T')[0];
            latestStatuses[`${entry.name}-${cleanDate}`] = entry.status;
        });

        for (const [key, status] of Object.entries(latestStatuses)) {
            const [name, date] = key.split('-');
            const dot = document.getElementById(`dot-${name}-${date}`);
            if (dot) {
                if (status === 'Available') dot.classList.add('free');
                else if (status === 'Busy') dot.classList.add('busy');
            }
        }

        document.querySelectorAll('.day').forEach(dayBox => {
            const dateStr = dayBox.id.replace('day-', '');
            const allFree = crew.every(name => latestStatuses[`${name}-${dateStr}`] === 'Available');
            if (allFree) dayBox.classList.add('perfect');
            else dayBox.classList.remove('perfect');
        });
    }

    function clearSelection() {
        selectedDates.clear();
        document.querySelectorAll('.day').forEach(el => el.classList.remove('selected'));
    }

    function changeMonth(dir) {
        currentMonth += dir;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar();
    }

    async function submitBulk(status) {
        if (selectedDates.size === 0) return alert("Select some dates first!");
        const user = document.getElementById('user-select').value;
        const datesToProcess = Array.from(selectedDates);

        datesToProcess.forEach(dStr => {
            latestStatuses[`${user}-${dStr}`] = status;
            const dot = document.getElementById(`dot-${user}-${dStr}`);
            if(dot) dot.className = 'dot ' + (status === 'Available' ? 'free' : 'busy');
        });

        clearSelection();
        try {
            await Promise.all(datesToProcess.map(dStr => 
                fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ name: user, date: dStr, status: status }) })
            ));
            fetchData();
        } catch (e) { alert("Error updating Sheet."); }
    }

    renderCalendar();
    fetchData();
    setInterval(fetchData, 20000); // Sync every 20 seconds
</script>
</body>
</html>
